#!/bin/sh -eu

echo "$EXPORT_PATH $EXPORT_HOSTS($EXPORT_OPTIONS)" > /etc/exports
echo "/etc/exports file contents:"
cat /etc/exports
echo ------------------------------
echo

echo "=> starting NFS server..."
/usr/sbin/rpc.nfsd -d 8 -U -N 2 -N 3 -G 10 |:
echo

echo "=> exporting file system..."
/usr/sbin/exportfs -rv
/usr/sbin/exportfs
echo

# rpcbind is enabled for now to overcome a bug with slow startup, it shouldn't be required.
# But currently enabled to overcome an NFS bug around opening an IPv6 socket
echo "=> starting rpcbind..."
/sbin/rpcbind -w
echo "==> displaying rpcbind status..."
/sbin/rpcinfo
echo

echo "=> starting mountd in the foreground..."
/usr/sbin/rpc.mountd -d all -u -F -N 2 -N 3
echo
